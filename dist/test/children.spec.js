'use strict';

var _plump = require('plump');

var _base = require('../base');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _hapi = require('hapi');

var _hapi2 = _interopRequireDefault(_hapi);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_chai2.default.use(_chaiAsPromised2.default); /* eslint-env node, mocha*/
/* eslint no-shadow: 0 */

var expect = _chai2.default.expect;
describe('HasMany Plump Routes', function () {
  var ms = new _plump.MemoryStore({ terminal: true });
  var plump = new _plump.Plump({ types: [_plump.TestType], storage: [ms] });
  var basePlugin = new _base.BaseController(plump, _plump.TestType);
  var hapi = new _hapi2.default.Server();
  hapi.connection({ port: 80 });

  before(function () {
    return hapi.register(basePlugin.plugin, { routes: { prefix: '/api' } });
  });

  it('C', function () {
    var one = new _plump.TestType({ name: 'potato' }, plump);
    return one.$save().then(function () {
      return hapi.inject({
        method: 'PUT',
        url: '/api/' + one.$id + '/children',
        payload: JSON.stringify({ child_id: 100 })
      });
    }).then(function (response) {
      expect(response).to.have.property('statusCode', 200);
      return expect(one.$get('children')).to.eventually.deep.equal({ children: [{ id: 100 }] });
    });
  });

  it('R', function () {
    var one = new _plump.TestType({ name: 'potato' }, plump);
    return one.$save().then(function () {
      return one.$add('children', 100);
    }).then(function () {
      return hapi.inject({
        method: 'GET',
        url: '/api/' + one.$id + '/children'
      });
    }).then(function (response) {
      expect(response).to.have.property('statusCode', 200);
      return expect(one.$get('children')).to.eventually.deep.equal({ children: [{ id: 100 }] });
    });
  });

  it('U', function () {
    var one = new _plump.TestType({ name: 'potato' }, plump);
    return one.$save().then(function () {
      return one.$add('valenceChildren', 100, { perm: 2 });
    }).then(function () {
      return expect(one.$get('valenceChildren')).to.eventually.deep.equal({ valenceChildren: [{ id: 100, perm: 2 }] });
    }).then(function () {
      return hapi.inject({
        method: 'PATCH',
        url: '/api/' + one.$id + '/valenceChildren/100',
        payload: JSON.stringify({ perm: 3 })
      });
    }).then(function () {
      return expect(plump.find('tests', one.$id).$get('valenceChildren')).to.eventually.deep.equal({ valenceChildren: [{ id: 100, perm: 3 }] });
    });
  });

  it('D', function () {
    var one = new _plump.TestType({ name: 'potato' }, plump);
    return one.$save().then(function () {
      return one.$add('children', 100);
    }).then(function () {
      return expect(one.$get('children')).to.eventually.deep.equal({ children: [{ id: 100 }] });
    }).then(function () {
      return hapi.inject({
        method: 'DELETE',
        url: '/api/' + one.$id + '/children/100'
      });
    }).then(function () {
      return expect(plump.find('tests', one.$id).$get('children')).to.eventually.deep.equal({ children: [] });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvY2hpbGRyZW4uc3BlYy5qcyJdLCJuYW1lcyI6WyJ1c2UiLCJleHBlY3QiLCJkZXNjcmliZSIsIm1zIiwidGVybWluYWwiLCJwbHVtcCIsInR5cGVzIiwic3RvcmFnZSIsImJhc2VQbHVnaW4iLCJoYXBpIiwiU2VydmVyIiwiY29ubmVjdGlvbiIsInBvcnQiLCJiZWZvcmUiLCJyZWdpc3RlciIsInBsdWdpbiIsInJvdXRlcyIsInByZWZpeCIsIml0Iiwib25lIiwibmFtZSIsIiRzYXZlIiwidGhlbiIsImluamVjdCIsIm1ldGhvZCIsInVybCIsIiRpZCIsInBheWxvYWQiLCJKU09OIiwic3RyaW5naWZ5IiwiY2hpbGRfaWQiLCJyZXNwb25zZSIsInRvIiwiaGF2ZSIsInByb3BlcnR5IiwiJGdldCIsImV2ZW50dWFsbHkiLCJkZWVwIiwiZXF1YWwiLCJjaGlsZHJlbiIsImlkIiwiJGFkZCIsInBlcm0iLCJ2YWxlbmNlQ2hpbGRyZW4iLCJmaW5kIl0sIm1hcHBpbmdzIjoiOztBQUdBOztBQUNBOztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsZUFBS0EsR0FBTCwyQixDQVZBO0FBQ0E7O0FBVUEsSUFBTUMsU0FBUyxlQUFLQSxNQUFwQjtBQUNBQyxTQUFTLHNCQUFULEVBQWlDLFlBQU07QUFDckMsTUFBTUMsS0FBSyx1QkFBZ0IsRUFBRUMsVUFBVSxJQUFaLEVBQWhCLENBQVg7QUFDQSxNQUFNQyxRQUFRLGlCQUFVLEVBQUVDLE9BQU8saUJBQVQsRUFBcUJDLFNBQVMsQ0FBQ0osRUFBRCxDQUE5QixFQUFWLENBQWQ7QUFDQSxNQUFNSyxhQUFhLHlCQUFtQkgsS0FBbkIsa0JBQW5CO0FBQ0EsTUFBTUksT0FBTyxJQUFJLGVBQUtDLE1BQVQsRUFBYjtBQUNBRCxPQUFLRSxVQUFMLENBQWdCLEVBQUVDLE1BQU0sRUFBUixFQUFoQjs7QUFFQUMsU0FBTyxZQUFNO0FBQ1gsV0FBT0osS0FBS0ssUUFBTCxDQUFjTixXQUFXTyxNQUF6QixFQUFpQyxF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LFVBQWxDLENBQVAsRUFBc0RILEVBQXRELENBQXlESSxVQUF6RCxDQUFvRUMsSUFBcEUsQ0FBeUVDLEtBQXpFLENBQStFLEVBQUVDLFVBQVUsRUFBWixFQUEvRSxDQUFOO0FBQUEsS0FYQyxDQUFQO0FBWUQsR0FkRDtBQWVELENBN0VEIiwiZmlsZSI6InRlc3QvY2hpbGRyZW4uc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1lbnYgbm9kZSwgbW9jaGEqL1xuLyogZXNsaW50IG5vLXNoYWRvdzogMCAqL1xuXG5pbXBvcnQgeyBUZXN0VHlwZSwgUGx1bXAsIE1lbW9yeVN0b3JlIH0gZnJvbSAncGx1bXAnO1xuaW1wb3J0IHsgQmFzZUNvbnRyb2xsZXIgfSBmcm9tICcuLi9iYXNlJztcblxuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgSGFwaSBmcm9tICdoYXBpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcblxuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuY29uc3QgZXhwZWN0ID0gY2hhaS5leHBlY3Q7XG5kZXNjcmliZSgnSGFzTWFueSBQbHVtcCBSb3V0ZXMnLCAoKSA9PiB7XG4gIGNvbnN0IG1zID0gbmV3IE1lbW9yeVN0b3JlKHsgdGVybWluYWw6IHRydWUgfSk7XG4gIGNvbnN0IHBsdW1wID0gbmV3IFBsdW1wKHsgdHlwZXM6IFtUZXN0VHlwZV0sIHN0b3JhZ2U6IFttc10gfSk7XG4gIGNvbnN0IGJhc2VQbHVnaW4gPSBuZXcgQmFzZUNvbnRyb2xsZXIocGx1bXAsIFRlc3RUeXBlKTtcbiAgY29uc3QgaGFwaSA9IG5ldyBIYXBpLlNlcnZlcigpO1xuICBoYXBpLmNvbm5lY3Rpb24oeyBwb3J0OiA4MCB9KTtcblxuICBiZWZvcmUoKCkgPT4ge1xuICAgIHJldHVybiBoYXBpLnJlZ2lzdGVyKGJhc2VQbHVnaW4ucGx1Z2luLCB7IHJvdXRlczogeyBwcmVmaXg6ICcvYXBpJyB9IH0pO1xuICB9KTtcblxuICBpdCgnQycsICgpID0+IHtcbiAgICBjb25zdCBvbmUgPSBuZXcgVGVzdFR5cGUoeyBuYW1lOiAncG90YXRvJyB9LCBwbHVtcCk7XG4gICAgcmV0dXJuIG9uZS4kc2F2ZSgpXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGhhcGkuaW5qZWN0KHtcbiAgICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgICAgdXJsOiBgL2FwaS8ke29uZS4kaWR9L2NoaWxkcmVuYCxcbiAgICAgICAgcGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoeyBjaGlsZF9pZDogMTAwIH0pLFxuICAgICAgfSk7XG4gICAgfSlcbiAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgIGV4cGVjdChyZXNwb25zZSkudG8uaGF2ZS5wcm9wZXJ0eSgnc3RhdHVzQ29kZScsIDIwMCk7XG4gICAgICByZXR1cm4gZXhwZWN0KG9uZS4kZ2V0KCdjaGlsZHJlbicpKS50by5ldmVudHVhbGx5LmRlZXAuZXF1YWwoeyBjaGlsZHJlbjogW3sgaWQ6IDEwMCB9XSB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ1InLCAoKSA9PiB7XG4gICAgY29uc3Qgb25lID0gbmV3IFRlc3RUeXBlKHsgbmFtZTogJ3BvdGF0bycgfSwgcGx1bXApO1xuICAgIHJldHVybiBvbmUuJHNhdmUoKVxuICAgIC50aGVuKCgpID0+IG9uZS4kYWRkKCdjaGlsZHJlbicsIDEwMCkpXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGhhcGkuaW5qZWN0KHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgdXJsOiBgL2FwaS8ke29uZS4kaWR9L2NoaWxkcmVuYCxcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBleHBlY3QocmVzcG9uc2UpLnRvLmhhdmUucHJvcGVydHkoJ3N0YXR1c0NvZGUnLCAyMDApO1xuICAgICAgcmV0dXJuIGV4cGVjdChvbmUuJGdldCgnY2hpbGRyZW4nKSkudG8uZXZlbnR1YWxseS5kZWVwLmVxdWFsKHsgY2hpbGRyZW46IFt7IGlkOiAxMDAgfV0gfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdVJywgKCkgPT4ge1xuICAgIGNvbnN0IG9uZSA9IG5ldyBUZXN0VHlwZSh7IG5hbWU6ICdwb3RhdG8nIH0sIHBsdW1wKTtcbiAgICByZXR1cm4gb25lLiRzYXZlKClcbiAgICAudGhlbigoKSA9PiBvbmUuJGFkZCgndmFsZW5jZUNoaWxkcmVuJywgMTAwLCB7IHBlcm06IDIgfSkpXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGV4cGVjdChvbmUuJGdldCgndmFsZW5jZUNoaWxkcmVuJykpLnRvLmV2ZW50dWFsbHkuZGVlcC5lcXVhbCh7IHZhbGVuY2VDaGlsZHJlbjogW3sgaWQ6IDEwMCwgcGVybTogMiB9XSB9KTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBoYXBpLmluamVjdCh7XG4gICAgICAgIG1ldGhvZDogJ1BBVENIJyxcbiAgICAgICAgdXJsOiBgL2FwaS8ke29uZS4kaWR9L3ZhbGVuY2VDaGlsZHJlbi8xMDBgLFxuICAgICAgICBwYXlsb2FkOiBKU09OLnN0cmluZ2lmeSh7IHBlcm06IDMgfSksXG4gICAgICB9KTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBleHBlY3QocGx1bXAuZmluZCgndGVzdHMnLCBvbmUuJGlkKS4kZ2V0KCd2YWxlbmNlQ2hpbGRyZW4nKSkudG8uZXZlbnR1YWxseS5kZWVwLmVxdWFsKHsgdmFsZW5jZUNoaWxkcmVuOiBbeyBpZDogMTAwLCBwZXJtOiAzIH1dIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBpdCgnRCcsICgpID0+IHtcbiAgICBjb25zdCBvbmUgPSBuZXcgVGVzdFR5cGUoeyBuYW1lOiAncG90YXRvJyB9LCBwbHVtcCk7XG4gICAgcmV0dXJuIG9uZS4kc2F2ZSgpXG4gICAgLnRoZW4oKCkgPT4gb25lLiRhZGQoJ2NoaWxkcmVuJywgMTAwKSlcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gZXhwZWN0KG9uZS4kZ2V0KCdjaGlsZHJlbicpKS50by5ldmVudHVhbGx5LmRlZXAuZXF1YWwoeyBjaGlsZHJlbjogW3sgaWQ6IDEwMCB9XSB9KTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBoYXBpLmluamVjdCh7XG4gICAgICAgIG1ldGhvZDogJ0RFTEVURScsXG4gICAgICAgIHVybDogYC9hcGkvJHtvbmUuJGlkfS9jaGlsZHJlbi8xMDBgLFxuICAgICAgfSk7XG4gICAgfSlcbiAgICAudGhlbigoKSA9PiBleHBlY3QocGx1bXAuZmluZCgndGVzdHMnLCBvbmUuJGlkKS4kZ2V0KCdjaGlsZHJlbicpKS50by5ldmVudHVhbGx5LmRlZXAuZXF1YWwoeyBjaGlsZHJlbjogW10gfSkpO1xuICB9KTtcbn0pO1xuIl19
