"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mergeOptions = require("merge-options");
var Boom = require("boom");
function generateAuthRequest(options, services) {
    return function (req) {
        var getActor = options.actorMapFn
            ? options.actorMapFn
            : function (v) { return v; };
        if (options.kind === 'attributes') {
            switch (options.action) {
                case 'create':
                    return {
                        data: req.payload,
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'read':
                    return {
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'update':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'delete':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'query':
                    return {
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
            }
        }
        else if (options.kind === 'relationship') {
            var childModel = services.plump.types[options.model.schema.relationships[options.relationship].type.sides[options.relationship].otherType];
            switch (options.action) {
                case 'create':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        meta: req.payload.meta,
                        child: { type: childModel.type, id: req.payload.id },
                    };
                case 'read':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                    };
                case 'update':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.payload.id },
                        meta: req.payload.meta,
                    };
                case 'delete':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.payload.id },
                    };
            }
        }
    };
}
exports.authorize = function (options, services) {
    return function (o) {
        var i = mergeOptions({}, o);
        if (services.oracle && services.oracle.authorizers[options.model.type]) {
            if (i.config.pre === undefined) {
                i.config.pre = [];
            }
            var authMap_1 = generateAuthRequest(options, services);
            i.config.pre = i.config.pre.concat({
                assign: 'authorize',
                method: function (req, reply) {
                    services.oracle.dispatch(authMap_1(req)).then(function (v) {
                        if (v.result === true) {
                            reply(true);
                        }
                        else {
                            reply(Boom.unauthorized());
                        }
                    });
                },
            });
        }
        return i;
    };
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDOzRCQUNOLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQzt3QkFDN0IsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMiLCJmaWxlIjoiYXV0aG9yaXplLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kZWwsIE1vZGVsRGF0YSwgTW9kZWxSZWZlcmVuY2UsIFBsdW1wIH0gZnJvbSAncGx1bXAnO1xuaW1wb3J0ICogYXMgSGFwaSBmcm9tICdoYXBpJztcbmltcG9ydCAqIGFzIG1lcmdlT3B0aW9ucyBmcm9tICdtZXJnZS1vcHRpb25zJztcbmltcG9ydCAqIGFzIEpvaSBmcm9tICdqb2knO1xuaW1wb3J0ICogYXMgQm9vbSBmcm9tICdib29tJztcbmltcG9ydCB7XG4gIEF1dGhvcml6ZVJlcXVlc3QsXG4gIFNlZ21lbnRHZW5lcmF0b3IsXG4gIFRyYW5zZm9ybWVyLFxuICBSb3V0ZU9wdGlvbnMsXG4gIFN0cnV0Um91dGVDb25maWd1cmF0aW9uLFxuICBTdHJ1dFNlcnZpY2VzLFxufSBmcm9tICcuL2RhdGFUeXBlcyc7XG5pbXBvcnQgeyBPcmFjbGUgfSBmcm9tICcuL29yYWNsZSc7XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQXV0aFJlcXVlc3QoXG4gIG9wdGlvbnM6IFJvdXRlT3B0aW9ucyxcbiAgc2VydmljZXM6IFN0cnV0U2VydmljZXMsXG4pOiAocjogSGFwaS5SZXF1ZXN0KSA9PiBBdXRob3JpemVSZXF1ZXN0IHtcbiAgcmV0dXJuIChyZXE6IEhhcGkuUmVxdWVzdCkgPT4ge1xuICAgIGNvbnN0IGdldEFjdG9yID0gb3B0aW9ucy5hY3Rvck1hcEZuXG4gICAgICA/IG9wdGlvbnMuYWN0b3JNYXBGblxuICAgICAgOiAodjogTW9kZWxSZWZlcmVuY2UpID0+IHY7XG4gICAgaWYgKG9wdGlvbnMua2luZCA9PT0gJ2F0dHJpYnV0ZXMnKSB7XG4gICAgICBzd2l0Y2ggKG9wdGlvbnMuYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2NyZWF0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRhdGE6IHJlcS5wYXlsb2FkLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSB9LFxuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICdyZWFkJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRhdGE6IHJlcS5wYXlsb2FkLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ2RlbGV0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRhdGE6IHJlcS5wYXlsb2FkLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ3F1ZXJ5JzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSB9LFxuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICB9O1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAob3B0aW9ucy5raW5kID09PSAncmVsYXRpb25zaGlwJykge1xuICAgICAgY29uc3QgY2hpbGRNb2RlbCA9XG4gICAgICAgIHNlcnZpY2VzLnBsdW1wLnR5cGVzW1xuICAgICAgICAgIG9wdGlvbnMubW9kZWwuc2NoZW1hLnJlbGF0aW9uc2hpcHNbb3B0aW9ucy5yZWxhdGlvbnNoaXBdLnR5cGUuc2lkZXNbXG4gICAgICAgICAgICBvcHRpb25zLnJlbGF0aW9uc2hpcFxuICAgICAgICAgIF0ub3RoZXJUeXBlXG4gICAgICAgIF07XG4gICAgICBzd2l0Y2ggKG9wdGlvbnMuYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2NyZWF0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICByZWxhdGlvbnNoaXA6IG9wdGlvbnMucmVsYXRpb25zaGlwLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBtZXRhOiByZXEucGF5bG9hZC5tZXRhLFxuICAgICAgICAgICAgY2hpbGQ6IHsgdHlwZTogY2hpbGRNb2RlbC50eXBlLCBpZDogcmVxLnBheWxvYWQuaWQgfSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICdyZWFkJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcDogb3B0aW9ucy5yZWxhdGlvbnNoaXAsXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgcmVsYXRpb25zaGlwOiBvcHRpb25zLnJlbGF0aW9uc2hpcCxcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgICAgY2hpbGQ6IHsgdHlwZTogY2hpbGRNb2RlbC50eXBlLCBpZDogcmVxLnBheWxvYWQuaWQgfSxcbiAgICAgICAgICAgIG1ldGE6IHJlcS5wYXlsb2FkLm1ldGEsXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAnZGVsZXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcDogb3B0aW9ucy5yZWxhdGlvbnNoaXAsXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGNoaWxkOiB7IHR5cGU6IGNoaWxkTW9kZWwudHlwZSwgaWQ6IHJlcS5wYXlsb2FkLmlkIH0sXG4gICAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBhdXRob3JpemU6IFNlZ21lbnRHZW5lcmF0b3IgPSAoXG4gIG9wdGlvbnM6IFJvdXRlT3B0aW9ucyxcbiAgc2VydmljZXM6IFN0cnV0U2VydmljZXMsXG4pID0+IHtcbiAgcmV0dXJuIChvOiBQYXJ0aWFsPFN0cnV0Um91dGVDb25maWd1cmF0aW9uPikgPT4ge1xuICAgIGNvbnN0IGkgPSBtZXJnZU9wdGlvbnMoe30sIG8pO1xuICAgIGlmIChzZXJ2aWNlcy5vcmFjbGUgJiYgc2VydmljZXMub3JhY2xlLmF1dGhvcml6ZXJzW29wdGlvbnMubW9kZWwudHlwZV0pIHtcbiAgICAgIGlmIChpLmNvbmZpZy5wcmUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpLmNvbmZpZy5wcmUgPSBbXTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGF1dGhNYXAgPSBnZW5lcmF0ZUF1dGhSZXF1ZXN0KG9wdGlvbnMsIHNlcnZpY2VzKTtcbiAgICAgIGkuY29uZmlnLnByZSA9IGkuY29uZmlnLnByZS5jb25jYXQoe1xuICAgICAgICBhc3NpZ246ICdhdXRob3JpemUnLFxuICAgICAgICBtZXRob2Q6IChyZXE6IEhhcGkuUmVxdWVzdCwgcmVwbHk6IEhhcGkuQmFzZV9SZXBseSkgPT4ge1xuICAgICAgICAgIHNlcnZpY2VzLm9yYWNsZS5kaXNwYXRjaChhdXRoTWFwKHJlcSkpLnRoZW4odiA9PiB7XG4gICAgICAgICAgICBpZiAodi5yZXN1bHQgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgcmVwbHkodHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXBseShCb29tLnVuYXV0aG9yaXplZCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gaTtcbiAgfTtcbn07XG4iXX0=
