"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mergeOptions = require("merge-options");
var Boom = require("boom");
function generateAuthRequest(options, services) {
    var getActor = services.oracle.authorizers[options.model.type]
        .mapActor
        ? services.oracle.authorizers[options.model.type].mapActor
        : function (v) { return v; };
    return function (req) {
        if (options.kind === 'attributes') {
            switch (options.action) {
                case 'create':
                    return {
                        data: req.payload,
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'read':
                    return {
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'update':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'delete':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'query':
                    return {
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
            }
        }
        else if (options.kind === 'relationship') {
            var childModel = services.plump.types[options.model.schema.relationships[options.relationship].type.sides[options.relationship].otherType];
            switch (options.action) {
                case 'create':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        meta: req.payload.meta,
                        child: { type: childModel.type, id: req.payload.id },
                    };
                case 'read':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                    };
                case 'update':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.payload.id },
                        meta: req.payload.meta,
                    };
                case 'delete':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.payload.id },
                    };
            }
        }
    };
}
exports.authorize = function (options, services) {
    return function (o) {
        var i = mergeOptions({}, o);
        if (services.oracle && services.oracle.authorizers[options.model.type]) {
            if (i.config.pre === undefined) {
                i.config.pre = [];
            }
            var authMap_1 = generateAuthRequest(options, services);
            i.config.pre = i.config.pre.concat({
                assign: 'authorize',
                method: function (req, reply) {
                    services.oracle.dispatch(authMap_1(req)).then(function (v) {
                        if (v.result === true) {
                            reply(true);
                        }
                        else {
                            reply(Boom.unauthorized());
                        }
                    });
                },
            });
        }
        return i;
    };
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7NEJBQ3RCLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDZCxDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNOLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQzt3QkFDN0IsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMiLCJmaWxlIjoiYXV0aG9yaXplLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kZWwsIE1vZGVsRGF0YSwgTW9kZWxSZWZlcmVuY2UsIFBsdW1wIH0gZnJvbSAncGx1bXAnO1xuaW1wb3J0ICogYXMgSGFwaSBmcm9tICdoYXBpJztcbmltcG9ydCAqIGFzIG1lcmdlT3B0aW9ucyBmcm9tICdtZXJnZS1vcHRpb25zJztcbmltcG9ydCAqIGFzIEpvaSBmcm9tICdqb2knO1xuaW1wb3J0ICogYXMgQm9vbSBmcm9tICdib29tJztcbmltcG9ydCB7XG4gIEF1dGhvcml6ZVJlcXVlc3QsXG4gIFNlZ21lbnRHZW5lcmF0b3IsXG4gIFRyYW5zZm9ybWVyLFxuICBSb3V0ZU9wdGlvbnMsXG4gIFN0cnV0Um91dGVDb25maWd1cmF0aW9uLFxuICBTdHJ1dFNlcnZpY2VzLFxuICBBY3Rvck1hcEZuLFxufSBmcm9tICcuL2RhdGFUeXBlcyc7XG5pbXBvcnQgeyBPcmFjbGUgfSBmcm9tICcuL29yYWNsZSc7XG5cbmZ1bmN0aW9uIGdlbmVyYXRlQXV0aFJlcXVlc3QoXG4gIG9wdGlvbnM6IFJvdXRlT3B0aW9ucyxcbiAgc2VydmljZXM6IFN0cnV0U2VydmljZXMsXG4pOiAocjogSGFwaS5SZXF1ZXN0KSA9PiBBdXRob3JpemVSZXF1ZXN0IHtcbiAgY29uc3QgZ2V0QWN0b3I6IEFjdG9yTWFwRm4gPSBzZXJ2aWNlcy5vcmFjbGUuYXV0aG9yaXplcnNbb3B0aW9ucy5tb2RlbC50eXBlXVxuICAgIC5tYXBBY3RvclxuICAgID8gc2VydmljZXMub3JhY2xlLmF1dGhvcml6ZXJzW29wdGlvbnMubW9kZWwudHlwZV0ubWFwQWN0b3JcbiAgICA6IHYgPT4gdjtcbiAgcmV0dXJuIChyZXE6IEhhcGkuUmVxdWVzdCkgPT4ge1xuICAgIGlmIChvcHRpb25zLmtpbmQgPT09ICdhdHRyaWJ1dGVzJykge1xuICAgICAgc3dpdGNoIChvcHRpb25zLmFjdGlvbikge1xuICAgICAgICBjYXNlICdjcmVhdGUnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkYXRhOiByZXEucGF5bG9hZCxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUgfSxcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAncmVhZCc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkYXRhOiByZXEucGF5bG9hZCxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICdkZWxldGUnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkYXRhOiByZXEucGF5bG9hZCxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICdxdWVyeSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUgfSxcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMua2luZCA9PT0gJ3JlbGF0aW9uc2hpcCcpIHtcbiAgICAgIGNvbnN0IGNoaWxkTW9kZWwgPVxuICAgICAgICBzZXJ2aWNlcy5wbHVtcC50eXBlc1tcbiAgICAgICAgICBvcHRpb25zLm1vZGVsLnNjaGVtYS5yZWxhdGlvbnNoaXBzW29wdGlvbnMucmVsYXRpb25zaGlwXS50eXBlLnNpZGVzW1xuICAgICAgICAgICAgb3B0aW9ucy5yZWxhdGlvbnNoaXBcbiAgICAgICAgICBdLm90aGVyVHlwZVxuICAgICAgICBdO1xuICAgICAgc3dpdGNoIChvcHRpb25zLmFjdGlvbikge1xuICAgICAgICBjYXNlICdjcmVhdGUnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgcmVsYXRpb25zaGlwOiBvcHRpb25zLnJlbGF0aW9uc2hpcCxcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgICAgbWV0YTogcmVxLnBheWxvYWQubWV0YSxcbiAgICAgICAgICAgIGNoaWxkOiB7IHR5cGU6IGNoaWxkTW9kZWwudHlwZSwgaWQ6IHJlcS5wYXlsb2FkLmlkIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAncmVhZCc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICByZWxhdGlvbnNoaXA6IG9wdGlvbnMucmVsYXRpb25zaGlwLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcDogb3B0aW9ucy5yZWxhdGlvbnNoaXAsXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGNoaWxkOiB7IHR5cGU6IGNoaWxkTW9kZWwudHlwZSwgaWQ6IHJlcS5wYXlsb2FkLmlkIH0sXG4gICAgICAgICAgICBtZXRhOiByZXEucGF5bG9hZC5tZXRhLFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ2RlbGV0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICByZWxhdGlvbnNoaXA6IG9wdGlvbnMucmVsYXRpb25zaGlwLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBjaGlsZDogeyB0eXBlOiBjaGlsZE1vZGVsLnR5cGUsIGlkOiByZXEucGF5bG9hZC5pZCB9LFxuICAgICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgYXV0aG9yaXplOiBTZWdtZW50R2VuZXJhdG9yID0gKFxuICBvcHRpb25zOiBSb3V0ZU9wdGlvbnMsXG4gIHNlcnZpY2VzOiBTdHJ1dFNlcnZpY2VzLFxuKSA9PiB7XG4gIHJldHVybiAobzogUGFydGlhbDxTdHJ1dFJvdXRlQ29uZmlndXJhdGlvbj4pID0+IHtcbiAgICBjb25zdCBpID0gbWVyZ2VPcHRpb25zKHt9LCBvKTtcbiAgICBpZiAoc2VydmljZXMub3JhY2xlICYmIHNlcnZpY2VzLm9yYWNsZS5hdXRob3JpemVyc1tvcHRpb25zLm1vZGVsLnR5cGVdKSB7XG4gICAgICBpZiAoaS5jb25maWcucHJlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaS5jb25maWcucHJlID0gW107XG4gICAgICB9XG4gICAgICBjb25zdCBhdXRoTWFwID0gZ2VuZXJhdGVBdXRoUmVxdWVzdChvcHRpb25zLCBzZXJ2aWNlcyk7XG4gICAgICBpLmNvbmZpZy5wcmUgPSBpLmNvbmZpZy5wcmUuY29uY2F0KHtcbiAgICAgICAgYXNzaWduOiAnYXV0aG9yaXplJyxcbiAgICAgICAgbWV0aG9kOiAocmVxOiBIYXBpLlJlcXVlc3QsIHJlcGx5OiBIYXBpLkJhc2VfUmVwbHkpID0+IHtcbiAgICAgICAgICBzZXJ2aWNlcy5vcmFjbGUuZGlzcGF0Y2goYXV0aE1hcChyZXEpKS50aGVuKHYgPT4ge1xuICAgICAgICAgICAgaWYgKHYucmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgIHJlcGx5KHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVwbHkoQm9vbS51bmF1dGhvcml6ZWQoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGk7XG4gIH07XG59O1xuIl19
