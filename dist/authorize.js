"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mergeOptions = require("merge-options");
var Boom = require("boom");
function generateAuthRequest(options, services) {
    var getActor = services.oracle.authorizers[options.model.type]
        .mapActor
        ? services.oracle.authorizers[options.model.type].mapActor
        : function (v) { return v; };
    return function (req) {
        if (options.kind === 'attributes') {
            switch (options.action) {
                case 'create':
                    return {
                        data: req.payload,
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'read':
                    return {
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'update':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'delete':
                    return {
                        data: req.payload,
                        target: { type: options.model.type, id: req.params.itemId },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
                case 'query':
                    return {
                        target: { type: options.model.type },
                        kind: options.kind,
                        action: options.action,
                        actor: getActor(req.auth.credentials.user),
                    };
            }
        }
        else if (options.kind === 'relationship') {
            var childModel = services.plump.types[options.model.schema.relationships[options.relationship].type.sides[options.relationship].otherType];
            switch (options.action) {
                case 'create':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        meta: req.payload.meta,
                        child: { type: childModel.type, id: req.payload.id },
                    };
                case 'read':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                    };
                case 'update':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.params.childId },
                        meta: req.payload.meta,
                    };
                case 'delete':
                    return {
                        kind: options.kind,
                        action: options.action,
                        relationship: options.relationship,
                        actor: getActor(req.auth.credentials.user),
                        target: { type: options.model.type, id: req.params.itemId },
                        child: { type: childModel.type, id: req.params.childId },
                    };
            }
        }
    };
}
exports.authorize = function (options, services) {
    return function (o) {
        var i = mergeOptions({}, o);
        if (services.oracle && services.oracle.authorizers[options.model.type]) {
            if (i.config.pre === undefined) {
                i.config.pre = [];
            }
            var authMap_1 = generateAuthRequest(options, services);
            i.config.auth = 'token';
            i.config.pre = i.config.pre.concat({
                assign: 'authorize',
                method: function (req, reply) {
                    services.oracle.dispatch(authMap_1(req)).then(function (v) {
                        if (v.result === true) {
                            reply(true);
                        }
                        else {
                            reply(Boom.unauthorized());
                        }
                    });
                },
            });
        }
        return i;
    };
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQzt3QkFDM0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDOzRCQUN0QixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ2QsQ0FBQzt3QkFBQyxJQUFJLENBQUMsQ0FBQzs0QkFDTixLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7d0JBQzdCLENBQUM7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6ImF1dGhvcml6ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZGVsLCBNb2RlbERhdGEsIE1vZGVsUmVmZXJlbmNlLCBQbHVtcCB9IGZyb20gJ3BsdW1wJztcbmltcG9ydCAqIGFzIEhhcGkgZnJvbSAnaGFwaSc7XG5pbXBvcnQgKiBhcyBtZXJnZU9wdGlvbnMgZnJvbSAnbWVyZ2Utb3B0aW9ucyc7XG5pbXBvcnQgKiBhcyBKb2kgZnJvbSAnam9pJztcbmltcG9ydCAqIGFzIEJvb20gZnJvbSAnYm9vbSc7XG5pbXBvcnQge1xuICBBdXRob3JpemVSZXF1ZXN0LFxuICBTZWdtZW50R2VuZXJhdG9yLFxuICBUcmFuc2Zvcm1lcixcbiAgUm91dGVPcHRpb25zLFxuICBTdHJ1dFJvdXRlQ29uZmlndXJhdGlvbixcbiAgU3RydXRTZXJ2aWNlcyxcbiAgQWN0b3JNYXBGbixcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuaW1wb3J0IHsgT3JhY2xlIH0gZnJvbSAnLi9vcmFjbGUnO1xuXG5mdW5jdGlvbiBnZW5lcmF0ZUF1dGhSZXF1ZXN0KFxuICBvcHRpb25zOiBSb3V0ZU9wdGlvbnMsXG4gIHNlcnZpY2VzOiBTdHJ1dFNlcnZpY2VzLFxuKTogKHI6IEhhcGkuUmVxdWVzdCkgPT4gQXV0aG9yaXplUmVxdWVzdCB7XG4gIGNvbnN0IGdldEFjdG9yOiBBY3Rvck1hcEZuID0gc2VydmljZXMub3JhY2xlLmF1dGhvcml6ZXJzW29wdGlvbnMubW9kZWwudHlwZV1cbiAgICAubWFwQWN0b3JcbiAgICA/IHNlcnZpY2VzLm9yYWNsZS5hdXRob3JpemVyc1tvcHRpb25zLm1vZGVsLnR5cGVdLm1hcEFjdG9yXG4gICAgOiB2ID0+IHY7XG4gIHJldHVybiAocmVxOiBIYXBpLlJlcXVlc3QpID0+IHtcbiAgICBpZiAob3B0aW9ucy5raW5kID09PSAnYXR0cmlidXRlcycpIHtcbiAgICAgIHN3aXRjaCAob3B0aW9ucy5hY3Rpb24pIHtcbiAgICAgICAgY2FzZSAnY3JlYXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF0YTogcmVxLnBheWxvYWQsXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlIH0sXG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ3JlYWQnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF0YTogcmVxLnBheWxvYWQsXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAnZGVsZXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF0YTogcmVxLnBheWxvYWQsXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAncXVlcnknOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlIH0sXG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgIH07XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChvcHRpb25zLmtpbmQgPT09ICdyZWxhdGlvbnNoaXAnKSB7XG4gICAgICBjb25zdCBjaGlsZE1vZGVsID1cbiAgICAgICAgc2VydmljZXMucGx1bXAudHlwZXNbXG4gICAgICAgICAgb3B0aW9ucy5tb2RlbC5zY2hlbWEucmVsYXRpb25zaGlwc1tvcHRpb25zLnJlbGF0aW9uc2hpcF0udHlwZS5zaWRlc1tcbiAgICAgICAgICAgIG9wdGlvbnMucmVsYXRpb25zaGlwXG4gICAgICAgICAgXS5vdGhlclR5cGVcbiAgICAgICAgXTtcbiAgICAgIHN3aXRjaCAob3B0aW9ucy5hY3Rpb24pIHtcbiAgICAgICAgY2FzZSAnY3JlYXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcDogb3B0aW9ucy5yZWxhdGlvbnNoaXAsXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIG1ldGE6IHJlcS5wYXlsb2FkLm1ldGEsXG4gICAgICAgICAgICBjaGlsZDogeyB0eXBlOiBjaGlsZE1vZGVsLnR5cGUsIGlkOiByZXEucGF5bG9hZC5pZCB9LFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ3JlYWQnOlxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBraW5kOiBvcHRpb25zLmtpbmQsXG4gICAgICAgICAgICBhY3Rpb246IG9wdGlvbnMuYWN0aW9uLFxuICAgICAgICAgICAgcmVsYXRpb25zaGlwOiBvcHRpb25zLnJlbGF0aW9uc2hpcCxcbiAgICAgICAgICAgIGFjdG9yOiBnZXRBY3RvcihyZXEuYXV0aC5jcmVkZW50aWFscy51c2VyKSxcbiAgICAgICAgICAgIHRhcmdldDogeyB0eXBlOiBvcHRpb25zLm1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLml0ZW1JZCB9LFxuICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGtpbmQ6IG9wdGlvbnMua2luZCxcbiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9ucy5hY3Rpb24sXG4gICAgICAgICAgICByZWxhdGlvbnNoaXA6IG9wdGlvbnMucmVsYXRpb25zaGlwLFxuICAgICAgICAgICAgYWN0b3I6IGdldEFjdG9yKHJlcS5hdXRoLmNyZWRlbnRpYWxzLnVzZXIpLFxuICAgICAgICAgICAgdGFyZ2V0OiB7IHR5cGU6IG9wdGlvbnMubW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuaXRlbUlkIH0sXG4gICAgICAgICAgICBjaGlsZDogeyB0eXBlOiBjaGlsZE1vZGVsLnR5cGUsIGlkOiByZXEucGFyYW1zLmNoaWxkSWQgfSxcbiAgICAgICAgICAgIG1ldGE6IHJlcS5wYXlsb2FkLm1ldGEsXG4gICAgICAgICAgfTtcbiAgICAgICAgY2FzZSAnZGVsZXRlJzpcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAga2luZDogb3B0aW9ucy5raW5kLFxuICAgICAgICAgICAgYWN0aW9uOiBvcHRpb25zLmFjdGlvbixcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcDogb3B0aW9ucy5yZWxhdGlvbnNoaXAsXG4gICAgICAgICAgICBhY3RvcjogZ2V0QWN0b3IocmVxLmF1dGguY3JlZGVudGlhbHMudXNlciksXG4gICAgICAgICAgICB0YXJnZXQ6IHsgdHlwZTogb3B0aW9ucy5tb2RlbC50eXBlLCBpZDogcmVxLnBhcmFtcy5pdGVtSWQgfSxcbiAgICAgICAgICAgIGNoaWxkOiB7IHR5cGU6IGNoaWxkTW9kZWwudHlwZSwgaWQ6IHJlcS5wYXJhbXMuY2hpbGRJZCB9LFxuICAgICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgYXV0aG9yaXplOiBTZWdtZW50R2VuZXJhdG9yID0gKFxuICBvcHRpb25zOiBSb3V0ZU9wdGlvbnMsXG4gIHNlcnZpY2VzOiBTdHJ1dFNlcnZpY2VzLFxuKSA9PiB7XG4gIHJldHVybiAobzogUGFydGlhbDxTdHJ1dFJvdXRlQ29uZmlndXJhdGlvbj4pID0+IHtcbiAgICBjb25zdCBpID0gbWVyZ2VPcHRpb25zKHt9LCBvKTtcbiAgICBpZiAoc2VydmljZXMub3JhY2xlICYmIHNlcnZpY2VzLm9yYWNsZS5hdXRob3JpemVyc1tvcHRpb25zLm1vZGVsLnR5cGVdKSB7XG4gICAgICBpZiAoaS5jb25maWcucHJlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaS5jb25maWcucHJlID0gW107XG4gICAgICB9XG4gICAgICBjb25zdCBhdXRoTWFwID0gZ2VuZXJhdGVBdXRoUmVxdWVzdChvcHRpb25zLCBzZXJ2aWNlcyk7XG4gICAgICBpLmNvbmZpZy5hdXRoID0gJ3Rva2VuJztcbiAgICAgIGkuY29uZmlnLnByZSA9IGkuY29uZmlnLnByZS5jb25jYXQoe1xuICAgICAgICBhc3NpZ246ICdhdXRob3JpemUnLFxuICAgICAgICBtZXRob2Q6IChyZXE6IEhhcGkuUmVxdWVzdCwgcmVwbHk6IEhhcGkuQmFzZV9SZXBseSkgPT4ge1xuICAgICAgICAgIHNlcnZpY2VzLm9yYWNsZS5kaXNwYXRjaChhdXRoTWFwKHJlcSkpLnRoZW4odiA9PiB7XG4gICAgICAgICAgICBpZiAodi5yZXN1bHQgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgcmVwbHkodHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXBseShCb29tLnVuYXV0aG9yaXplZCgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gaTtcbiAgfTtcbn07XG4iXX0=
