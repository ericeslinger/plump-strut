"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function test(msg, server) {
    return server.services.tokenStore
        .tokenToUser(msg.key)
        .then(function (v) {
        if (!!v) {
            return {
                response: 'testkey',
                you: v,
                auth: true,
                token: msg.key,
            };
        }
        else {
            return {
                response: 'testkey',
                auth: false,
            };
        }
    })
        .then(function (response) {
        if (response.auth === true && server.extensions['loginExtras']) {
            return server.extensions['loginExtras'](response.you).then(function (r) {
                return Object.assign(response, { included: r });
            });
        }
    })
        .then(function (response) {
        return {
            broadcast: false,
            key: msg.responseKey,
            msg: response,
        };
    });
}
function start(msg, server) {
    msg.client.join(msg.nonce);
    return {
        key: msg.request,
        broadcast: false,
        msg: {
            response: 'startauth',
            types: server.config.authTypes.map(function (v) {
                return {
                    name: v.name,
                    iconUrl: v.iconUrl,
                    url: "" + server.baseUrl() + server.config
                        .authRoot + "?method=" + v.name + "&nonce=" + msg.nonce,
                };
            }),
        },
    };
}
exports.AuthenticationChannel = {
    auth: function (msg, strut) {
        return Promise.resolve().then(function () {
            if (msg.request === 'startauth') {
                return start(msg, strut);
            }
            else if (msg.request === 'testkey') {
                return test(msg, strut);
            }
            else {
                return {
                    broadcast: false,
                    key: 'error',
                    msg: {
                        response: 'invalidRequest',
                    },
                };
            }
        });
    },
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zb2NrZXQvYXV0aGVudGljYXRpb24uY2hhbm5lbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWdCQSxjQUNFLEdBQWlDLEVBQ2pDLE1BQW1CO0lBRW5CLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFVBQVU7U0FDOUIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7U0FDcEIsSUFBSSxDQUFDLFVBQUEsQ0FBQztRQUNMLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1IsTUFBTSxDQUFDO2dCQUNMLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixHQUFHLEVBQUUsQ0FBQztnQkFDTixJQUFJLEVBQUUsSUFBSTtnQkFDVixLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUc7YUFDZixDQUFDO1FBQ0osQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDO2dCQUNMLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixJQUFJLEVBQUUsS0FBSzthQUNaLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLFVBQUMsUUFBc0I7UUFDM0IsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxJQUFJLElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLENBQUM7Z0JBQzFELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQztTQUNELElBQUksQ0FBQyxVQUFDLFFBQXNCO1FBQzNCLE1BQU0sQ0FBQztZQUNMLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLEdBQUcsRUFBRSxHQUFHLENBQUMsV0FBVztZQUNwQixHQUFHLEVBQUUsUUFBUTtTQUNkLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxlQUNFLEdBQStCLEVBQy9CLE1BQW1CO0lBRW5CLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQixNQUFNLENBQUM7UUFDTCxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQU87UUFDaEIsU0FBUyxFQUFFLEtBQUs7UUFDaEIsR0FBRyxFQUFFO1lBQ0gsUUFBUSxFQUFFLFdBQVc7WUFDckIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFBLENBQUM7Z0JBQ2xDLE1BQU0sQ0FBQztvQkFDTCxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUk7b0JBQ1osT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPO29CQUNsQixHQUFHLEVBQUUsS0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU07eUJBQ3JDLFFBQVEsZ0JBQVcsQ0FBQyxDQUFDLElBQUksZUFBVSxHQUFHLENBQUMsS0FBTztpQkFDbEQsQ0FBQztZQUNKLENBQUMsQ0FBQztTQUNIO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFWSxRQUFBLHFCQUFxQixHQUFtQjtJQUNuRCxJQUFJLEVBQUUsVUFBQyxHQUEwQixFQUFFLEtBQWtCO1FBQ25ELE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUUzQjtZQUNBLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0IsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzFCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixNQUFNLENBQUM7b0JBQ0wsU0FBUyxFQUFFLEtBQUs7b0JBQ2hCLEdBQUcsRUFBRSxPQUFPO29CQUNaLEdBQUcsRUFBRTt3QkFDSCxRQUFRLEVBQUUsZ0JBQWdCO3FCQUMzQjtpQkFDRixDQUFDO1lBQ0osQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUMiLCJmaWxlIjoic29ja2V0L2F1dGhlbnRpY2F0aW9uLmNoYW5uZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBTb2NrZXRJTyBmcm9tICdzb2NrZXQuaW8nO1xuaW1wb3J0IHsgU3RydXRTZXJ2ZXIgfSBmcm9tICcuLi9kYXRhVHlwZXMnO1xuaW1wb3J0IHtcbiAgU2luZ2xldG9uUmVxdWVzdCxcbiAgQXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBUZXN0S2V5QXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBTdGFydEF1dGhlbnRpY2F0aW9uUmVxdWVzdCxcbiAgU3RhcnRSZXNwb25zZSxcbiAgVGVzdFJlc3BvbnNlLFxuICBBdXRoZW50aWNhdGlvblJlc3BvbnNlLFxuICBTb2NrZXREaXNwYXRjaCxcbiAgUmVzcG9uc2VFbnZlbG9wZSxcbn0gZnJvbSAnLi9kYXRhVHlwZXMnO1xuXG5pbXBvcnQgeyBDaGFubmVsUmVxdWVzdCB9IGZyb20gJy4vZGF0YVR5cGVzJztcblxuZnVuY3Rpb24gdGVzdChcbiAgbXNnOiBUZXN0S2V5QXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBzZXJ2ZXI6IFN0cnV0U2VydmVyLFxuKTogUHJvbWlzZTxSZXNwb25zZUVudmVsb3BlPFRlc3RSZXNwb25zZT4+IHtcbiAgcmV0dXJuIHNlcnZlci5zZXJ2aWNlcy50b2tlblN0b3JlXG4gICAgLnRva2VuVG9Vc2VyKG1zZy5rZXkpXG4gICAgLnRoZW4odiA9PiB7XG4gICAgICBpZiAoISF2KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmVzcG9uc2U6ICd0ZXN0a2V5JyxcbiAgICAgICAgICB5b3U6IHYsXG4gICAgICAgICAgYXV0aDogdHJ1ZSxcbiAgICAgICAgICB0b2tlbjogbXNnLmtleSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmVzcG9uc2U6ICd0ZXN0a2V5JyxcbiAgICAgICAgICBhdXRoOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC50aGVuKChyZXNwb25zZTogVGVzdFJlc3BvbnNlKSA9PiB7XG4gICAgICBpZiAocmVzcG9uc2UuYXV0aCA9PT0gdHJ1ZSAmJiBzZXJ2ZXIuZXh0ZW5zaW9uc1snbG9naW5FeHRyYXMnXSkge1xuICAgICAgICByZXR1cm4gc2VydmVyLmV4dGVuc2lvbnNbJ2xvZ2luRXh0cmFzJ10ocmVzcG9uc2UueW91KS50aGVuKHIgPT4ge1xuICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHJlc3BvbnNlLCB7IGluY2x1ZGVkOiByIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC50aGVuKChyZXNwb25zZTogVGVzdFJlc3BvbnNlKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBicm9hZGNhc3Q6IGZhbHNlLFxuICAgICAgICBrZXk6IG1zZy5yZXNwb25zZUtleSxcbiAgICAgICAgbXNnOiByZXNwb25zZSxcbiAgICAgIH07XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0KFxuICBtc2c6IFN0YXJ0QXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBzZXJ2ZXI6IFN0cnV0U2VydmVyLFxuKTogUmVzcG9uc2VFbnZlbG9wZTxTdGFydFJlc3BvbnNlPiB7XG4gIG1zZy5jbGllbnQuam9pbihtc2cubm9uY2UpO1xuICByZXR1cm4ge1xuICAgIGtleTogbXNnLnJlcXVlc3QsXG4gICAgYnJvYWRjYXN0OiBmYWxzZSxcbiAgICBtc2c6IHtcbiAgICAgIHJlc3BvbnNlOiAnc3RhcnRhdXRoJyxcbiAgICAgIHR5cGVzOiBzZXJ2ZXIuY29uZmlnLmF1dGhUeXBlcy5tYXAodiA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogdi5uYW1lLFxuICAgICAgICAgIGljb25Vcmw6IHYuaWNvblVybCxcbiAgICAgICAgICB1cmw6IGAke3NlcnZlci5iYXNlVXJsKCl9JHtzZXJ2ZXIuY29uZmlnXG4gICAgICAgICAgICAuYXV0aFJvb3R9P21ldGhvZD0ke3YubmFtZX0mbm9uY2U9JHttc2cubm9uY2V9YCxcbiAgICAgICAgfTtcbiAgICAgIH0pLFxuICAgIH0sXG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBBdXRoZW50aWNhdGlvbkNoYW5uZWw6IFNvY2tldERpc3BhdGNoID0ge1xuICBhdXRoOiAobXNnOiBBdXRoZW50aWNhdGlvblJlcXVlc3QsIHN0cnV0OiBTdHJ1dFNlcnZlcikgPT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuPFxuICAgICAgUmVzcG9uc2VFbnZlbG9wZTxBdXRoZW50aWNhdGlvblJlc3BvbnNlPlxuICAgID4oKCkgPT4ge1xuICAgICAgaWYgKG1zZy5yZXF1ZXN0ID09PSAnc3RhcnRhdXRoJykge1xuICAgICAgICByZXR1cm4gc3RhcnQobXNnLCBzdHJ1dCk7XG4gICAgICB9IGVsc2UgaWYgKG1zZy5yZXF1ZXN0ID09PSAndGVzdGtleScpIHtcbiAgICAgICAgcmV0dXJuIHRlc3QobXNnLCBzdHJ1dCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGJyb2FkY2FzdDogZmFsc2UsXG4gICAgICAgICAga2V5OiAnZXJyb3InLFxuICAgICAgICAgIG1zZzoge1xuICAgICAgICAgICAgcmVzcG9uc2U6ICdpbnZhbGlkUmVxdWVzdCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcbn07XG4iXX0=
