"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Boom = require("boom");
var Joi = require("joi");
var routes_1 = require("./routes");
var mergeOptions = require("merge-options");
var baseRoutes = routes_1.createRoutes();
function plugin(server, _, next) {
    var _this = this;
    server.route(this.constructor.routes
        .map(function (method) { return _this.route(method, baseRoutes[method]); })
        .reduce(function (acc, curr) { return acc.concat(curr); }, []));
    server.route(this.extraRoutes());
    next();
}
var BaseController = (function () {
    function BaseController(plump, model, options) {
        if (options === void 0) { options = {}; }
        this.plump = plump;
        this.model = model;
        this.options = Object.assign({}, { sideloads: [] }, options);
        this.plugin = plugin.bind(this);
        this.plugin.attributes = Object.assign({}, {
            version: '1.0.0',
            name: this.model.typeName,
        }, this.options.plugin);
    }
    BaseController.prototype.extraRoutes = function () {
        return [];
    };
    BaseController.prototype.read = function () {
        return function (request) { return Promise.resolve(request.pre.item.data); };
    };
    BaseController.prototype.update = function () {
        return function (request) {
            return request.pre.item.ref.set(request.payload).save();
        };
    };
    BaseController.prototype.delete = function () {
        return function (request) {
            return request.pre.item.ref.delete();
        };
    };
    BaseController.prototype.create = function () {
        var _this = this;
        return function (request) {
            return new _this.model(request.payload.attributes, _this.plump).save();
        };
    };
    BaseController.prototype.addChild = function (_a) {
        var field = _a.field;
        return function (request) {
            return request.pre.item.ref.add(field, request.payload).save();
        };
    };
    BaseController.prototype.listChildren = function (_a) {
        var field = _a.field;
        return function (request) { return request.pre.item.ref.get("relationships." + field); };
    };
    BaseController.prototype.removeChild = function (_a) {
        var field = _a.field;
        return function (request) {
            return request.pre.item.ref.remove(field, { id: request.params.childId }).save();
        };
    };
    BaseController.prototype.modifyChild = function (_a) {
        var field = _a.field;
        return function (request) {
            var update = {
                id: request.params.childId,
                meta: request.payload.meta,
            };
            return request.pre.item.ref.modifyRelationship(field, update).save();
        };
    };
    BaseController.prototype.query = function () {
        var _this = this;
        return function (request) {
            return _this.plump.query(request.query);
        };
    };
    BaseController.prototype.createHandler = function (method, options) {
        var handler = this[method](options);
        return function (request, reply) {
            return handler(request)
                .then(function (response) {
                reply(response).code(200);
            }).catch(function (err) {
                console.log(err);
                reply(Boom.badImplementation(err));
            });
        };
    };
    BaseController.prototype.createJoiValidator = function (field) {
        try {
            var schema_1 = this.model.schema;
            if (field) {
                if (field in schema_1.attributes) {
                    return _a = {}, _a[field] = Joi[schema_1.attributes[field].type](), _a;
                }
                else if (field in schema_1.relationships) {
                    var dataSchema_1 = {
                        id: Joi.number(),
                    };
                    if (schema_1.relationships[field].type.extras) {
                        var extras_1 = schema_1.relationships[field].type.extras;
                        Object.keys(extras_1).forEach(function (extra) {
                            dataSchema_1.meta = dataSchema_1.meta || {};
                            dataSchema_1.meta[extra] = Joi[extras_1[extra].type]();
                        });
                    }
                    return dataSchema_1;
                }
                else {
                    return {};
                }
            }
            else {
                var retVal_1 = {
                    typeName: Joi.string(),
                    id: Joi.number(),
                    attributes: {},
                    relationships: {},
                };
                Object.keys(schema_1.attributes).forEach(function (attr) {
                    retVal_1.attributes[attr] = Joi[schema_1.attributes[attr].type]();
                });
                Object.keys(schema_1.relationships).forEach(function (relName) {
                    var itemSchema = { id: Joi.number() };
                    if (schema_1.relationships[relName].type.extras) {
                        var extras = schema_1.relationships[relName].type.extras;
                        for (var extra in extras) {
                            var extraType = extras[extra].type;
                            itemSchema.meta = itemSchema.meta || {};
                            itemSchema.meta[extra] = Joi[extraType]();
                        }
                    }
                    retVal_1.relationships[relName] = Joi.array().items(Joi.object({
                        op: Joi.string().valid('add', 'modify', 'remove'),
                        data: itemSchema,
                    }));
                });
                return retVal_1;
            }
        }
        catch (err) {
            console.log(err);
            return {};
        }
        var _a;
    };
    BaseController.prototype.loadHandler = function () {
        var _this = this;
        return {
            method: function (request, reply) {
                if (request.params && request.params.itemId) {
                    var item_1 = _this.plump.find({ typeName: _this.model.typeName, id: request.params.itemId });
                    return item_1.get()
                        .then(function (thing) {
                        if (thing) {
                            reply({
                                ref: item_1,
                                data: thing,
                            });
                        }
                        else {
                            reply(Boom.notFound());
                        }
                    }).catch(function (err) {
                        console.log(err);
                        reply(Boom.badImplementation(err));
                    });
                }
                else {
                    return reply(Boom.notFound());
                }
            },
            assign: 'item',
        };
    };
    BaseController.prototype.route = function (method, opts) {
        if (opts.plural) {
            return this.routeRelationships(method, opts);
        }
        else {
            return this.routeAttributes(method, opts);
        }
    };
    BaseController.prototype.approveHandler = function (method, opts) {
        return {
            method: function (request, reply) { return reply(true); },
            assign: 'approve',
        };
    };
    BaseController.prototype.routeRelationships = function (method, opts) {
        var _this = this;
        return Object.keys(this.model.schema.relationships).map(function (field) {
            var genericOpts = mergeOptions({}, opts, {
                validate: {},
                generatorOptions: { field: field },
            });
            genericOpts.hapi.path = genericOpts.hapi.path.replace('{field}', field);
            if (['POST', 'PUT', 'PATCH'].indexOf(genericOpts.hapi.method) >= 0) {
                genericOpts.validate.payload = _this.createJoiValidator(field);
            }
            genericOpts.plural = false;
            return _this.routeAttributes(method, genericOpts);
        });
    };
    BaseController.prototype.routeAttributes = function (method, opts) {
        var routeConfig = mergeOptions({}, {
            handler: opts.handler || this.createHandler(method, opts.generatorOptions),
            config: {
                pre: [this.approveHandler(method, opts.generatorOptions)],
                validate: {},
            },
        }, opts.hapi);
        if (opts.hapi.path.indexOf('itemId') >= 0) {
            routeConfig.config.pre.unshift(this.loadHandler());
        }
        if (opts.pre !== undefined) {
            opts.pre.forEach(function (p) { return routeConfig.config.pre.push(p); });
        }
        if (opts.validate && opts.validate.query) {
            routeConfig.config.validate.query = opts.validate.query;
        }
        if (opts.validate && opts.validate.params) {
            routeConfig.config.validate.params = opts.validate.params;
        }
        if (opts.validate && opts.validate.payload === true) {
            routeConfig.config.validate.payload = this.createJoiValidator();
        }
        else if (opts.validate && opts.validate.payload) {
            routeConfig.config.validate.payload = opts.validate.payload;
        }
        return routeConfig;
    };
    return BaseController;
}());
exports.BaseController = BaseController;
BaseController.routes = [
    'read',
    'query',
    'listChildren',
    'addChild',
    'removeChild',
    'modifyChild',
    'create',
    'update',
    'delete',
];

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBQTZCO0FBQzdCLHlCQUEyQjtBQUMzQixtQ0FBd0M7QUFDeEMsNENBQThDO0FBSzlDLElBQU0sVUFBVSxHQUFHLHFCQUFZLEVBQUUsQ0FBQztBQUVsQyxnQkFBZ0IsTUFBTSxFQUFFLENBQUMsRUFBRSxJQUFJO0lBQS9CLGlCQVFDO0lBUEMsTUFBTSxDQUFDLEtBQUssQ0FDVixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU07U0FDdEIsR0FBRyxDQUFDLFVBQUMsTUFBTSxJQUFLLE9BQUEsS0FBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQXRDLENBQXNDLENBQUM7U0FDdkQsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLElBQUksSUFBSyxPQUFBLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQWhCLENBQWdCLEVBQUUsRUFBRSxDQUFDLENBQzdDLENBQUM7SUFDRixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLElBQUksRUFBRSxDQUFDO0FBQ1QsQ0FBQztBQWVEO0lBV0Usd0JBQVksS0FBWSxFQUFFLEtBQW1CLEVBQUUsT0FBWTtRQUFaLHdCQUFBLEVBQUEsWUFBWTtRQUN6RCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUN6QyxPQUFPLEVBQUUsT0FBTztZQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRO1NBQzFCLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsb0NBQVcsR0FBWDtRQUNFLE1BQU0sQ0FBQyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsNkJBQUksR0FBSjtRQUNFLE1BQU0sQ0FBQyxVQUFDLE9BQW1CLElBQUssT0FBQSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUF0QyxDQUFzQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCwrQkFBTSxHQUFOO1FBQ0UsTUFBTSxDQUFDLFVBQUMsT0FBbUI7WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFELENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCwrQkFBTSxHQUFOO1FBQ0UsTUFBTSxDQUFDLFVBQUMsT0FBbUI7WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN2QyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsK0JBQU0sR0FBTjtRQUFBLGlCQUlDO1FBSEMsTUFBTSxDQUFDLFVBQUMsT0FBTztZQUNiLE1BQU0sQ0FBQyxJQUFJLEtBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZFLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxpQ0FBUSxHQUFSLFVBQVMsRUFBUztZQUFQLGdCQUFLO1FBQ2QsTUFBTSxDQUFDLFVBQUMsT0FBbUI7WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqRSxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQscUNBQVksR0FBWixVQUFhLEVBQVM7WUFBUCxnQkFBSztRQUNsQixNQUFNLENBQUMsVUFBQyxPQUFtQixJQUFLLE9BQUEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxtQkFBaUIsS0FBTyxDQUFDLEVBQWxELENBQWtELENBQUM7SUFDckYsQ0FBQztJQUVELG9DQUFXLEdBQVgsVUFBWSxFQUFTO1lBQVAsZ0JBQUs7UUFDakIsTUFBTSxDQUFDLFVBQUMsT0FBbUI7WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwRixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsb0NBQVcsR0FBWCxVQUFZLEVBQVM7WUFBUCxnQkFBSztRQUNqQixNQUFNLENBQUMsVUFBQyxPQUFtQjtZQUN6QixJQUFNLE1BQU0sR0FBRztnQkFDYixFQUFFLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPO2dCQUMxQixJQUFJLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJO2FBQzNCLENBQUM7WUFDRixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2RSxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsOEJBQUssR0FBTDtRQUFBLGlCQUlDO1FBSEMsTUFBTSxDQUFDLFVBQUMsT0FBTztZQUNiLE1BQU0sQ0FBQyxLQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELHNDQUFhLEdBQWIsVUFBYyxNQUFNLEVBQUUsT0FBTztRQUMzQixJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsTUFBTSxDQUFDLFVBQUMsT0FBcUIsRUFBRSxLQUFrQjtZQUMvQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztpQkFDdEIsSUFBSSxDQUFDLFVBQUMsUUFBUTtnQkFDYixLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzVCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7Z0JBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsS0FBSyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELDJDQUFrQixHQUFsQixVQUFtQixLQUFjO1FBQy9CLElBQUksQ0FBQztZQUNILElBQU0sUUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ2pDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLFFBQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO29CQUMvQixNQUFNLFVBQUcsR0FBQyxLQUFLLElBQUcsR0FBRyxDQUFDLFFBQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBRztnQkFDM0QsQ0FBQztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLFFBQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO29CQUN6QyxJQUFNLFlBQVUsR0FBUTt3QkFDdEIsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUU7cUJBQ2pCLENBQUM7b0JBRUYsRUFBRSxDQUFDLENBQUMsUUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzt3QkFDNUMsSUFBTSxRQUFNLEdBQUcsUUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO3dCQUV2RCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEtBQUs7NEJBQy9CLFlBQVUsQ0FBQyxJQUFJLEdBQUcsWUFBVSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7NEJBQ3hDLFlBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLFFBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO3dCQUNyRCxDQUFDLENBQUMsQ0FBQztvQkFDTCxDQUFDO29CQUNELE1BQU0sQ0FBQyxZQUFVLENBQUM7Z0JBQ3BCLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sTUFBTSxDQUFDLEVBQUUsQ0FBQztnQkFDWixDQUFDO1lBQ0gsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLElBQU0sUUFBTSxHQUFRO29CQUNsQixRQUFRLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRTtvQkFDdEIsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUU7b0JBQ2hCLFVBQVUsRUFBRSxFQUFFO29CQUNkLGFBQWEsRUFBRSxFQUFFO2lCQUNsQixDQUFDO2dCQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7b0JBQ3pDLFFBQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLFFBQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDaEUsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsT0FBTztvQkFDL0MsSUFBTSxVQUFVLEdBQVEsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7b0JBRTdDLEVBQUUsQ0FBQyxDQUFDLFFBQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQzlDLElBQU0sTUFBTSxHQUFHLFFBQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQzt3QkFFekQsR0FBRyxDQUFDLENBQUMsSUFBTSxLQUFLLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQzs0QkFDM0IsSUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQzs0QkFDckMsVUFBVSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQzs0QkFDeEMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQzt3QkFDNUMsQ0FBQztvQkFDSCxDQUFDO29CQUNELFFBQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDO3dCQUMzRCxFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQzt3QkFDakQsSUFBSSxFQUFFLFVBQVU7cUJBQ2pCLENBQUMsQ0FBQyxDQUFDO2dCQUNOLENBQUMsQ0FBQyxDQUFDO2dCQUNILE1BQU0sQ0FBQyxRQUFNLENBQUM7WUFDaEIsQ0FBQztRQUNILENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqQixNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ1osQ0FBQzs7SUFDSCxDQUFDO0lBRUQsb0NBQVcsR0FBWDtRQUFBLGlCQXlCQztRQXhCQyxNQUFNLENBQUM7WUFDTCxNQUFNLEVBQUUsVUFBQyxPQUFPLEVBQUUsS0FBSztnQkFDckIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQzVDLElBQU0sTUFBSSxHQUFHLEtBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7b0JBQzNGLE1BQU0sQ0FBQyxNQUFJLENBQUMsR0FBRyxFQUFFO3lCQUNoQixJQUFJLENBQUMsVUFBQyxLQUFLO3dCQUNWLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7NEJBQ1YsS0FBSyxDQUFDO2dDQUNKLEdBQUcsRUFBRSxNQUFJO2dDQUNULElBQUksRUFBRSxLQUFLOzZCQUNaLENBQUMsQ0FBQzt3QkFDTCxDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNOLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQzt3QkFDekIsQ0FBQztvQkFDSCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ2pCLEtBQUssQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDckMsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUNoQyxDQUFDO1lBQ0gsQ0FBQztZQUNELE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQztJQUNKLENBQUM7SUFFRCw4QkFBSyxHQUFMLFVBQU0sTUFBTSxFQUFFLElBQUk7UUFDaEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDSCxDQUFDO0lBTUQsdUNBQWMsR0FBZCxVQUFlLE1BQU0sRUFBRSxJQUFJO1FBQ3pCLE1BQU0sQ0FBQztZQUNMLE1BQU0sRUFBRSxVQUFDLE9BQU8sRUFBRSxLQUFLLElBQUssT0FBQSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQVgsQ0FBVztZQUN2QyxNQUFNLEVBQUUsU0FBUztTQUNsQixDQUFDO0lBQ0osQ0FBQztJQUVELDJDQUFrQixHQUFsQixVQUFtQixNQUFNLEVBQUUsSUFBSTtRQUEvQixpQkFpQkM7UUFoQkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsS0FBSztZQUMzRCxJQUFNLFdBQVcsR0FBRyxZQUFZLENBQzlCLEVBQUUsRUFDRixJQUFJLEVBQ0o7Z0JBQ0UsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osZ0JBQWdCLEVBQUUsRUFBRSxLQUFLLE9BQUEsRUFBRTthQUM1QixDQUNGLENBQUM7WUFDRixXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU8sR0FBRyxLQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEUsQ0FBQztZQUNELFdBQVcsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQzNCLE1BQU0sQ0FBQyxLQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNuRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCx3Q0FBZSxHQUFmLFVBQWdCLE1BQU0sRUFBRSxJQUFJO1FBVzFCLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FDOUIsRUFBRSxFQUNGO1lBQ0UsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1lBQzFFLE1BQU0sRUFBRTtnQkFDTixHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztnQkFDekQsUUFBUSxFQUFFLEVBQUU7YUFDYjtTQUNGLEVBQ0QsSUFBSSxDQUFDLElBQUksQ0FDVixDQUFDO1FBRUYsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDekMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQzFELENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMxQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDNUQsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNwRCxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDbEUsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNsRCxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7UUFDOUQsQ0FBQztRQUNELE1BQU0sQ0FBQyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUNILHFCQUFDO0FBQUQsQ0F4UUEsQUF3UUMsSUFBQTtBQXhRWSx3Q0FBYztBQTBRM0IsY0FBYyxDQUFDLE1BQU0sR0FBRztJQUN0QixNQUFNO0lBQ04sT0FBTztJQUNQLGNBQWM7SUFDZCxVQUFVO0lBQ1YsYUFBYTtJQUNiLGFBQWE7SUFDYixRQUFRO0lBQ1IsUUFBUTtJQUNSLFFBQVE7Q0FDVCxDQUFDIiwiZmlsZSI6ImJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBCb29tIGZyb20gJ2Jvb20nO1xuaW1wb3J0ICogYXMgSm9pIGZyb20gJ2pvaSc7XG5pbXBvcnQgeyBjcmVhdGVSb3V0ZXMgfSBmcm9tICcuL3JvdXRlcyc7XG5pbXBvcnQgKiBhcyBtZXJnZU9wdGlvbnMgZnJvbSAnbWVyZ2Utb3B0aW9ucyc7XG5pbXBvcnQgeyBNb2RlbCwgUGx1bXAsIE1vZGVsRGF0YSwgTW9kZWxSZWZlcmVuY2UgfSBmcm9tICdwbHVtcCc7IC8vIHRzbGludDpkaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcmlhYmxlXG4vLyBuZWVkIHRvIGltcG9ydCBNb2RlbFJlZmVyZW5jZSBiZWNhdXNlIHNvbWUgb2YgdGhlIG1ldGhvZHMgcmV0dXJuIHRoZW0uXG5pbXBvcnQgKiBhcyBIYXBpIGZyb20gJ2hhcGknO1xuXG5jb25zdCBiYXNlUm91dGVzID0gY3JlYXRlUm91dGVzKCk7XG5cbmZ1bmN0aW9uIHBsdWdpbihzZXJ2ZXIsIF8sIG5leHQpIHtcbiAgc2VydmVyLnJvdXRlKFxuICAgIHRoaXMuY29uc3RydWN0b3Iucm91dGVzXG4gICAgLm1hcCgobWV0aG9kKSA9PiB0aGlzLnJvdXRlKG1ldGhvZCwgYmFzZVJvdXRlc1ttZXRob2RdKSlcbiAgICAucmVkdWNlKChhY2MsIGN1cnIpID0+IGFjYy5jb25jYXQoY3VyciksIFtdKSAvLyByb3V0ZVJlbGF0aW9uc2hpcCByZXR1cm5zIGFuIGFycmF5XG4gICk7XG4gIHNlcnZlci5yb3V0ZSh0aGlzLmV4dHJhUm91dGVzKCkpO1xuICBuZXh0KCk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGVkSXRlbSBleHRlbmRzIEhhcGkuUmVxdWVzdCB7XG4gIHByZToge1xuICAgIGl0ZW06IHtcbiAgICAgIHJlZjogTW9kZWwsXG4gICAgICBkYXRhOiBNb2RlbERhdGEsXG4gICAgfTtcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdHJ1dEhhbmRsZXI8VD4ge1xuICAocmVxdWVzdDogSGFwaS5SZXF1ZXN0KTogUHJvbWlzZTxUPjtcbn1cblxuZXhwb3J0IGNsYXNzIEJhc2VDb250cm9sbGVyIHtcbiAgcHVibGljIHBsdW1wOiBQbHVtcDtcbiAgcHVibGljIG1vZGVsOiB0eXBlb2YgTW9kZWw7XG4gIHB1YmxpYyBvcHRpb25zO1xuICBwdWJsaWMgcGx1Z2luOiB7XG4gICAgYXR0cmlidXRlczoge1xuICAgICAgdmVyc2lvbjogc3RyaW5nLFxuICAgICAgbmFtZTogc3RyaW5nXG4gICAgfVxuICB9O1xuICBzdGF0aWMgcm91dGVzOiBzdHJpbmdbXTtcbiAgY29uc3RydWN0b3IocGx1bXA6IFBsdW1wLCBtb2RlbDogdHlwZW9mIE1vZGVsLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLnBsdW1wID0gcGx1bXA7XG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xuICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHsgc2lkZWxvYWRzOiBbXSB9LCBvcHRpb25zKTtcbiAgICB0aGlzLnBsdWdpbiA9IHBsdWdpbi5iaW5kKHRoaXMpO1xuICAgIHRoaXMucGx1Z2luLmF0dHJpYnV0ZXMgPSBPYmplY3QuYXNzaWduKHt9LCB7XG4gICAgICB2ZXJzaW9uOiAnMS4wLjAnLFxuICAgICAgbmFtZTogdGhpcy5tb2RlbC50eXBlTmFtZSxcbiAgICB9LCB0aGlzLm9wdGlvbnMucGx1Z2luKTtcbiAgfVxuXG4gIGV4dHJhUm91dGVzKCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJlYWQoKTogU3RydXRIYW5kbGVyPE1vZGVsRGF0YT4ge1xuICAgIHJldHVybiAocmVxdWVzdDogUm91dGVkSXRlbSkgPT4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QucHJlLml0ZW0uZGF0YSk7XG4gIH1cblxuICB1cGRhdGUoKTogU3RydXRIYW5kbGVyPE1vZGVsRGF0YT4ge1xuICAgIHJldHVybiAocmVxdWVzdDogUm91dGVkSXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIHJlcXVlc3QucHJlLml0ZW0ucmVmLnNldChyZXF1ZXN0LnBheWxvYWQpLnNhdmUoKTtcbiAgICB9O1xuICB9XG5cbiAgZGVsZXRlKCk6IFN0cnV0SGFuZGxlcjx2b2lkPiB7XG4gICAgcmV0dXJuIChyZXF1ZXN0OiBSb3V0ZWRJdGVtKSA9PiB7XG4gICAgICByZXR1cm4gcmVxdWVzdC5wcmUuaXRlbS5yZWYuZGVsZXRlKCk7XG4gICAgfTtcbiAgfVxuXG4gIGNyZWF0ZSgpOiBTdHJ1dEhhbmRsZXI8TW9kZWxEYXRhPiB7XG4gICAgcmV0dXJuIChyZXF1ZXN0KSA9PiB7XG4gICAgICByZXR1cm4gbmV3IHRoaXMubW9kZWwocmVxdWVzdC5wYXlsb2FkLmF0dHJpYnV0ZXMsIHRoaXMucGx1bXApLnNhdmUoKTtcbiAgICB9O1xuICB9XG5cbiAgYWRkQ2hpbGQoeyBmaWVsZCB9KSB7XG4gICAgcmV0dXJuIChyZXF1ZXN0OiBSb3V0ZWRJdGVtKSA9PiB7XG4gICAgICByZXR1cm4gcmVxdWVzdC5wcmUuaXRlbS5yZWYuYWRkKGZpZWxkLCByZXF1ZXN0LnBheWxvYWQpLnNhdmUoKTtcbiAgICB9O1xuICB9XG5cbiAgbGlzdENoaWxkcmVuKHsgZmllbGQgfSk6IFN0cnV0SGFuZGxlcjxNb2RlbERhdGE+IHtcbiAgICByZXR1cm4gKHJlcXVlc3Q6IFJvdXRlZEl0ZW0pID0+IHJlcXVlc3QucHJlLml0ZW0ucmVmLmdldChgcmVsYXRpb25zaGlwcy4ke2ZpZWxkfWApO1xuICB9XG5cbiAgcmVtb3ZlQ2hpbGQoeyBmaWVsZCB9KSB7XG4gICAgcmV0dXJuIChyZXF1ZXN0OiBSb3V0ZWRJdGVtKSA9PiB7XG4gICAgICByZXR1cm4gcmVxdWVzdC5wcmUuaXRlbS5yZWYucmVtb3ZlKGZpZWxkLCB7IGlkOiByZXF1ZXN0LnBhcmFtcy5jaGlsZElkIH0gKS5zYXZlKCk7XG4gICAgfTtcbiAgfVxuXG4gIG1vZGlmeUNoaWxkKHsgZmllbGQgfSkge1xuICAgIHJldHVybiAocmVxdWVzdDogUm91dGVkSXRlbSkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlID0ge1xuICAgICAgICBpZDogcmVxdWVzdC5wYXJhbXMuY2hpbGRJZCxcbiAgICAgICAgbWV0YTogcmVxdWVzdC5wYXlsb2FkLm1ldGEsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHJlcXVlc3QucHJlLml0ZW0ucmVmLm1vZGlmeVJlbGF0aW9uc2hpcChmaWVsZCwgdXBkYXRlKS5zYXZlKCk7XG4gICAgfTtcbiAgfVxuXG4gIHF1ZXJ5KCkge1xuICAgIHJldHVybiAocmVxdWVzdCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucGx1bXAucXVlcnkocmVxdWVzdC5xdWVyeSk7XG4gICAgfTtcbiAgfVxuXG4gIGNyZWF0ZUhhbmRsZXIobWV0aG9kLCBvcHRpb25zKTogSGFwaS5JU2Vzc2lvbkhhbmRsZXIge1xuICAgIGNvbnN0IGhhbmRsZXIgPSB0aGlzW21ldGhvZF0ob3B0aW9ucyk7XG4gICAgcmV0dXJuIChyZXF1ZXN0OiBIYXBpLlJlcXVlc3QsIHJlcGx5OiBIYXBpLklSZXBseSkgPT4ge1xuICAgICAgcmV0dXJuIGhhbmRsZXIocmVxdWVzdClcbiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICByZXBseShyZXNwb25zZSkuY29kZSgyMDApO1xuICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICByZXBseShCb29tLmJhZEltcGxlbWVudGF0aW9uKGVycikpO1xuICAgICAgfSk7XG4gICAgfTtcbiAgfVxuXG4gIGNyZWF0ZUpvaVZhbGlkYXRvcihmaWVsZD86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlbWEgPSB0aGlzLm1vZGVsLnNjaGVtYTtcbiAgICAgIGlmIChmaWVsZCkge1xuICAgICAgICBpZiAoZmllbGQgaW4gc2NoZW1hLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICByZXR1cm4geyBbZmllbGRdOiBKb2lbc2NoZW1hLmF0dHJpYnV0ZXNbZmllbGRdLnR5cGVdKCkgfTtcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZCBpbiBzY2hlbWEucmVsYXRpb25zaGlwcykge1xuICAgICAgICAgIGNvbnN0IGRhdGFTY2hlbWE6IGFueSA9IHtcbiAgICAgICAgICAgIGlkOiBKb2kubnVtYmVyKCksXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGlmIChzY2hlbWEucmVsYXRpb25zaGlwc1tmaWVsZF0udHlwZS5leHRyYXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGV4dHJhcyA9IHNjaGVtYS5yZWxhdGlvbnNoaXBzW2ZpZWxkXS50eXBlLmV4dHJhcztcblxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZXh0cmFzKS5mb3JFYWNoKGV4dHJhID0+IHtcbiAgICAgICAgICAgICAgZGF0YVNjaGVtYS5tZXRhID0gZGF0YVNjaGVtYS5tZXRhIHx8IHt9O1xuICAgICAgICAgICAgICBkYXRhU2NoZW1hLm1ldGFbZXh0cmFdID0gSm9pW2V4dHJhc1tleHRyYV0udHlwZV0oKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gZGF0YVNjaGVtYTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJldFZhbDogYW55ID0ge1xuICAgICAgICAgIHR5cGVOYW1lOiBKb2kuc3RyaW5nKCksXG4gICAgICAgICAgaWQ6IEpvaS5udW1iZXIoKSxcbiAgICAgICAgICBhdHRyaWJ1dGVzOiB7fSxcbiAgICAgICAgICByZWxhdGlvbnNoaXBzOiB7fSxcbiAgICAgICAgfTtcblxuICAgICAgICBPYmplY3Qua2V5cyhzY2hlbWEuYXR0cmlidXRlcykuZm9yRWFjaChhdHRyID0+IHtcbiAgICAgICAgICByZXRWYWwuYXR0cmlidXRlc1thdHRyXSA9IEpvaVtzY2hlbWEuYXR0cmlidXRlc1thdHRyXS50eXBlXSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBPYmplY3Qua2V5cyhzY2hlbWEucmVsYXRpb25zaGlwcykuZm9yRWFjaChyZWxOYW1lID0+IHtcbiAgICAgICAgICBjb25zdCBpdGVtU2NoZW1hOiBhbnkgPSB7IGlkOiBKb2kubnVtYmVyKCkgfTtcblxuICAgICAgICAgIGlmIChzY2hlbWEucmVsYXRpb25zaGlwc1tyZWxOYW1lXS50eXBlLmV4dHJhcykge1xuICAgICAgICAgICAgY29uc3QgZXh0cmFzID0gc2NoZW1hLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0udHlwZS5leHRyYXM7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgZXh0cmEgaW4gZXh0cmFzKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZ3VhcmQtZm9yLWluXG4gICAgICAgICAgICAgIGNvbnN0IGV4dHJhVHlwZSA9IGV4dHJhc1tleHRyYV0udHlwZTtcbiAgICAgICAgICAgICAgaXRlbVNjaGVtYS5tZXRhID0gaXRlbVNjaGVtYS5tZXRhIHx8IHt9O1xuICAgICAgICAgICAgICBpdGVtU2NoZW1hLm1ldGFbZXh0cmFdID0gSm9pW2V4dHJhVHlwZV0oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0VmFsLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0gPSBKb2kuYXJyYXkoKS5pdGVtcyhKb2kub2JqZWN0KHtcbiAgICAgICAgICAgIG9wOiBKb2kuc3RyaW5nKCkudmFsaWQoJ2FkZCcsICdtb2RpZnknLCAncmVtb3ZlJyksXG4gICAgICAgICAgICBkYXRhOiBpdGVtU2NoZW1hLFxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXRWYWw7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuXG4gIGxvYWRIYW5kbGVyKCkge1xuICAgIHJldHVybiB7XG4gICAgICBtZXRob2Q6IChyZXF1ZXN0LCByZXBseSkgPT4ge1xuICAgICAgICBpZiAocmVxdWVzdC5wYXJhbXMgJiYgcmVxdWVzdC5wYXJhbXMuaXRlbUlkKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMucGx1bXAuZmluZCh7IHR5cGVOYW1lOiB0aGlzLm1vZGVsLnR5cGVOYW1lLCBpZDogcmVxdWVzdC5wYXJhbXMuaXRlbUlkIH0pO1xuICAgICAgICAgIHJldHVybiBpdGVtLmdldCgpXG4gICAgICAgICAgLnRoZW4oKHRoaW5nKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpbmcpIHtcbiAgICAgICAgICAgICAgcmVwbHkoe1xuICAgICAgICAgICAgICAgIHJlZjogaXRlbSxcbiAgICAgICAgICAgICAgICBkYXRhOiB0aGluZyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXBseShCb29tLm5vdEZvdW5kKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICByZXBseShCb29tLmJhZEltcGxlbWVudGF0aW9uKGVycikpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXBseShCb29tLm5vdEZvdW5kKCkpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgYXNzaWduOiAnaXRlbScsXG4gICAgfTtcbiAgfVxuXG4gIHJvdXRlKG1ldGhvZCwgb3B0cykge1xuICAgIGlmIChvcHRzLnBsdXJhbCkge1xuICAgICAgcmV0dXJuIHRoaXMucm91dGVSZWxhdGlvbnNoaXBzKG1ldGhvZCwgb3B0cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnJvdXRlQXR0cmlidXRlcyhtZXRob2QsIG9wdHMpO1xuICAgIH1cbiAgfVxuXG5cbiAgLy8gb3ZlcnJpZGUgYXBwcm92ZUhhbmRsZXIgd2l0aCB3aGF0ZXZlciBwZXItcm91dGVcbiAgLy8gbG9naWMgeW91IHdhbnQgLSByZXBseSB3aXRoIEJvb20ubm90QXV0aG9yaXplZCgpXG4gIC8vIG9yIGFueSBvdGhlciB2YWx1ZSBvbiBub24tYXBwcm92ZWQgc3RhdHVzXG4gIGFwcHJvdmVIYW5kbGVyKG1ldGhvZCwgb3B0cykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGhvZDogKHJlcXVlc3QsIHJlcGx5KSA9PiByZXBseSh0cnVlKSxcbiAgICAgIGFzc2lnbjogJ2FwcHJvdmUnLFxuICAgIH07XG4gIH1cblxuICByb3V0ZVJlbGF0aW9uc2hpcHMobWV0aG9kLCBvcHRzKSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMubW9kZWwuc2NoZW1hLnJlbGF0aW9uc2hpcHMpLm1hcChmaWVsZCA9PiB7XG4gICAgICBjb25zdCBnZW5lcmljT3B0cyA9IG1lcmdlT3B0aW9ucyhcbiAgICAgICAge30sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIHtcbiAgICAgICAgICB2YWxpZGF0ZToge30sXG4gICAgICAgICAgZ2VuZXJhdG9yT3B0aW9uczogeyBmaWVsZCB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgZ2VuZXJpY09wdHMuaGFwaS5wYXRoID0gZ2VuZXJpY09wdHMuaGFwaS5wYXRoLnJlcGxhY2UoJ3tmaWVsZH0nLCBmaWVsZCk7XG4gICAgICBpZiAoWydQT1NUJywgJ1BVVCcsICdQQVRDSCddLmluZGV4T2YoZ2VuZXJpY09wdHMuaGFwaS5tZXRob2QpID49IDApIHtcbiAgICAgICAgZ2VuZXJpY09wdHMudmFsaWRhdGUucGF5bG9hZCA9IHRoaXMuY3JlYXRlSm9pVmFsaWRhdG9yKGZpZWxkKTtcbiAgICAgIH1cbiAgICAgIGdlbmVyaWNPcHRzLnBsdXJhbCA9IGZhbHNlO1xuICAgICAgcmV0dXJuIHRoaXMucm91dGVBdHRyaWJ1dGVzKG1ldGhvZCwgZ2VuZXJpY09wdHMpO1xuICAgIH0pO1xuICB9XG5cbiAgcm91dGVBdHRyaWJ1dGVzKG1ldGhvZCwgb3B0cykge1xuICAgIC8qXG4gICAgb3B0czoge1xuICAgICAgcHJlOiBbQU5ZIFBSRUhBTkRMRVJzXVxuICAgICAgaGFuZGxlcjogaGFuZGxlciBvdmVycmlkZVxuICAgICAgdmFsaWRhdGU6IHtKb2kgYnkgdHlwZSAocGFyYW0sIHF1ZXJ5LCBwYXlsb2FkKX0sXG4gICAgICBhdXRoOiBhbnl0aGluZyBvdGhlciB0aGFuIHRva2VuLFxuICAgICAgaGFwaToge0FMTCBPVEhFUiBIQVBJIE9QVElPTlMsIE1VU1QgQkUgSlNPTiBTVFJJTkdJRllBQkxFfSxcbiAgICB9LFxuICAgICovXG5cbiAgICBjb25zdCByb3V0ZUNvbmZpZyA9IG1lcmdlT3B0aW9ucyhcbiAgICAgIHt9LFxuICAgICAge1xuICAgICAgICBoYW5kbGVyOiBvcHRzLmhhbmRsZXIgfHwgdGhpcy5jcmVhdGVIYW5kbGVyKG1ldGhvZCwgb3B0cy5nZW5lcmF0b3JPcHRpb25zKSxcbiAgICAgICAgY29uZmlnOiB7XG4gICAgICAgICAgcHJlOiBbdGhpcy5hcHByb3ZlSGFuZGxlcihtZXRob2QsIG9wdHMuZ2VuZXJhdG9yT3B0aW9ucyldLFxuICAgICAgICAgIHZhbGlkYXRlOiB7fSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcHRzLmhhcGlcbiAgICApO1xuXG4gICAgaWYgKG9wdHMuaGFwaS5wYXRoLmluZGV4T2YoJ2l0ZW1JZCcpID49IDApIHtcbiAgICAgIHJvdXRlQ29uZmlnLmNvbmZpZy5wcmUudW5zaGlmdCh0aGlzLmxvYWRIYW5kbGVyKCkpO1xuICAgIH1cblxuICAgIGlmIChvcHRzLnByZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHRzLnByZS5mb3JFYWNoKChwKSA9PiByb3V0ZUNvbmZpZy5jb25maWcucHJlLnB1c2gocCkpO1xuICAgIH1cblxuICAgIGlmIChvcHRzLnZhbGlkYXRlICYmIG9wdHMudmFsaWRhdGUucXVlcnkpIHtcbiAgICAgIHJvdXRlQ29uZmlnLmNvbmZpZy52YWxpZGF0ZS5xdWVyeSA9IG9wdHMudmFsaWRhdGUucXVlcnk7XG4gICAgfVxuXG4gICAgaWYgKG9wdHMudmFsaWRhdGUgJiYgb3B0cy52YWxpZGF0ZS5wYXJhbXMpIHtcbiAgICAgIHJvdXRlQ29uZmlnLmNvbmZpZy52YWxpZGF0ZS5wYXJhbXMgPSBvcHRzLnZhbGlkYXRlLnBhcmFtcztcbiAgICB9XG5cbiAgICBpZiAob3B0cy52YWxpZGF0ZSAmJiBvcHRzLnZhbGlkYXRlLnBheWxvYWQgPT09IHRydWUpIHtcbiAgICAgIHJvdXRlQ29uZmlnLmNvbmZpZy52YWxpZGF0ZS5wYXlsb2FkID0gdGhpcy5jcmVhdGVKb2lWYWxpZGF0b3IoKTtcbiAgICB9IGVsc2UgaWYgKG9wdHMudmFsaWRhdGUgJiYgb3B0cy52YWxpZGF0ZS5wYXlsb2FkKSB7XG4gICAgICByb3V0ZUNvbmZpZy5jb25maWcudmFsaWRhdGUucGF5bG9hZCA9IG9wdHMudmFsaWRhdGUucGF5bG9hZDtcbiAgICB9XG4gICAgcmV0dXJuIHJvdXRlQ29uZmlnO1xuICB9XG59XG5cbkJhc2VDb250cm9sbGVyLnJvdXRlcyA9IFtcbiAgJ3JlYWQnLFxuICAncXVlcnknLFxuICAnbGlzdENoaWxkcmVuJyxcbiAgJ2FkZENoaWxkJyxcbiAgJ3JlbW92ZUNoaWxkJyxcbiAgJ21vZGlmeUNoaWxkJyxcbiAgJ2NyZWF0ZScsXG4gICd1cGRhdGUnLFxuICAnZGVsZXRlJyxcbl07XG4iXX0=
