"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Oracle = (function () {
    function Oracle(keyService) {
        this.keyService = keyService;
        this.authorizers = {};
    }
    Oracle.prototype.addAuthorizer = function (auth, forType) {
        this.authorizers[forType] = auth;
    };
    Oracle.prototype.dispatch = function (request) {
        var _this = this;
        return Promise.resolve()
            .then(function () {
            if (request.kind === 'compound') {
                return Promise.all(request.list.map(function (v) { return _this.dispatch(v); }))
                    .then(function (res) {
                    return request.combinator === 'or'
                        ? res.some(function (v) { return v.result; })
                        : res.every(function (v) { return v.result; });
                })
                    .then(function (f) { return ({ kind: 'final', result: f }); });
            }
            else {
                return _this.authorizers[request.target.type].authorize(request);
            }
        })
            .then(function (v) {
            if (v.kind === 'final') {
                return v;
            }
            else if (v.kind === 'delegated') {
                return _this.dispatch(v.delegate);
            }
        });
    };
    Oracle.prototype.authorize = function (request) {
        return this.dispatch(request).then(function (f) { return f.result; });
    };
    return Oracle;
}());
exports.Oracle = Oracle;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9vcmFjbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFjQTtJQUdFLGdCQUFtQixVQUF1QjtRQUF2QixlQUFVLEdBQVYsVUFBVSxDQUFhO1FBRm5DLGdCQUFXLEdBQTZDLEVBQUUsQ0FBQztJQUVyQixDQUFDO0lBRTlDLDhCQUFhLEdBQWIsVUFBYyxJQUEwQixFQUFFLE9BQWU7UUFDdkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDbkMsQ0FBQztJQUVELHlCQUFRLEdBQVIsVUFBUyxPQUF5QjtRQUFsQyxpQkF1QkM7UUF0QkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7YUFDckIsSUFBSSxDQUFvQjtZQUN2QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsS0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO3FCQUN4RCxJQUFJLENBQ0gsVUFBQyxHQUE2QjtvQkFDNUIsT0FBQSxPQUFPLENBQUMsVUFBVSxLQUFLLElBQUk7MEJBQ3ZCLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxFQUFSLENBQVEsQ0FBQzswQkFDdkIsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVIsQ0FBUSxDQUFDO2dCQUY1QixDQUU0QixDQUMvQjtxQkFDQSxJQUFJLENBQXlCLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQTlCLENBQThCLENBQUMsQ0FBQztZQUN2RSxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEtBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEUsQ0FBQztRQUNILENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxVQUFBLENBQUM7WUFDTCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDbEMsTUFBTSxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25DLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCwwQkFBUyxHQUFULFVBQVUsT0FBeUI7UUFDakMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBeUIsSUFBSyxPQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVIsQ0FBUSxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUNILGFBQUM7QUFBRCxDQXJDQSxBQXFDQyxJQUFBO0FBckNZLHdCQUFNIiwiZmlsZSI6Im9yYWNsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEF1dGhvcml6ZXJEZWZpbml0aW9uLFxuICBBdXRob3JpemVSZXF1ZXN0LFxuICBBdXRob3JpemVSZXNwb25zZSxcbiAgRmluYWxBdXRob3JpemVSZXNwb25zZSxcbiAgS2V5U2VydmljZSxcbiAgSU9yYWNsZSxcbiAgUm91dGVPcHRpb25zLFxufSBmcm9tICcuL2RhdGFUeXBlcyc7XG5cbmltcG9ydCB7IE1vZGVsRGF0YSB9IGZyb20gJ3BsdW1wJztcblxuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2hhcGknO1xuXG5leHBvcnQgY2xhc3MgT3JhY2xlIGltcGxlbWVudHMgSU9yYWNsZSB7XG4gIHB1YmxpYyBhdXRob3JpemVyczogeyBbbmFtZTogc3RyaW5nXTogQXV0aG9yaXplckRlZmluaXRpb24gfSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBrZXlTZXJ2aWNlPzogS2V5U2VydmljZSkge31cblxuICBhZGRBdXRob3JpemVyKGF1dGg6IEF1dGhvcml6ZXJEZWZpbml0aW9uLCBmb3JUeXBlOiBzdHJpbmcpIHtcbiAgICB0aGlzLmF1dGhvcml6ZXJzW2ZvclR5cGVdID0gYXV0aDtcbiAgfVxuXG4gIGRpc3BhdGNoKHJlcXVlc3Q6IEF1dGhvcml6ZVJlcXVlc3QpOiBQcm9taXNlPEZpbmFsQXV0aG9yaXplUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuPEF1dGhvcml6ZVJlc3BvbnNlPigoKSA9PiB7XG4gICAgICAgIGlmIChyZXF1ZXN0LmtpbmQgPT09ICdjb21wb3VuZCcpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVxdWVzdC5saXN0Lm1hcCh2ID0+IHRoaXMuZGlzcGF0Y2godikpKVxuICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgIChyZXM6IEZpbmFsQXV0aG9yaXplUmVzcG9uc2VbXSkgPT5cbiAgICAgICAgICAgICAgICByZXF1ZXN0LmNvbWJpbmF0b3IgPT09ICdvcidcbiAgICAgICAgICAgICAgICAgID8gcmVzLnNvbWUodiA9PiB2LnJlc3VsdClcbiAgICAgICAgICAgICAgICAgIDogcmVzLmV2ZXJ5KHYgPT4gdi5yZXN1bHQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRoZW48RmluYWxBdXRob3JpemVSZXNwb25zZT4oZiA9PiAoeyBraW5kOiAnZmluYWwnLCByZXN1bHQ6IGYgfSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB0aGlzLmF1dGhvcml6ZXJzW3JlcXVlc3QudGFyZ2V0LnR5cGVdLmF1dGhvcml6ZShyZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKHYgPT4ge1xuICAgICAgICBpZiAodi5raW5kID09PSAnZmluYWwnKSB7XG4gICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgIH0gZWxzZSBpZiAodi5raW5kID09PSAnZGVsZWdhdGVkJykge1xuICAgICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoKHYuZGVsZWdhdGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIGF1dGhvcml6ZShyZXF1ZXN0OiBBdXRob3JpemVSZXF1ZXN0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2gocmVxdWVzdCkudGhlbigoZjogRmluYWxBdXRob3JpemVSZXNwb25zZSkgPT4gZi5yZXN1bHQpO1xuICB9XG59XG4iXX0=
